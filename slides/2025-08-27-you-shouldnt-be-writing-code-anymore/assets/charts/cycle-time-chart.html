<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Average PR Cycle Time - AI Impact Analysis</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.0/chart.umd.js"></script>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            margin: 0;
            padding: 10px;
            background-color: #f5f5f5;
            height: 100vh;
            box-sizing: border-box;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background-color: white;
            padding: 15px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            height: calc(100vh - 20px);
            box-sizing: border-box;
            display: flex;
            flex-direction: column;
        }
        h1 {
            color: #333;
            text-align: center;
            margin-bottom: 10px;
            font-size: 1.5em;
        }
        .legend {
            text-align: center;
            margin-bottom: 15px;
        }
        .legend-item {
            display: inline-block;
            margin: 0 15px;
            color: #999;
            font-size: 0.85em;
        }
        .legend-color {
            display: inline-block;
            width: 16px;
            height: 10px;
            margin-right: 6px;
            vertical-align: middle;
            border-radius: 2px;
            position: relative;
            top: -1px;
        }
        .main-content {
            display: flex;
            flex: 1;
            gap: 20px;
            min-height: 0;
        }
        .chart-container {
            position: relative;
            flex: 1;
            min-height: 0;
        }
        .stats {
            display: flex;
            flex-direction: column;
            justify-content: center;
            gap: 15px;
            width: 200px;
            flex-shrink: 0;
        }
        .stat-box {
            text-align: center;
            padding: 15px 20px;
            background-color: #f8f9fa;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }
        .stat-value {
            font-size: 1.8em;
            font-weight: bold;
            color: #333;
        }
        .stat-label {
            color: #999;
            margin-top: 8px;
            font-size: 0.85em;
        }
        .pre-ai { background-color: #95a5a6; }
        .crunch { background-color: #e74c3c; }
        .ai-powered { background-color: #27ae60; }
        .improvement-positive { color: #e74c3c; } /* Red for negative change */
    </style>
</head>
<body>
    <div class="container">
        <h1>Average PR Cycle Time</h1>
        
        <div class="legend">
            <span class="legend-item">
                <span class="legend-color pre-ai"></span>Pre-AI
            </span>
            <span class="legend-item">
                <span class="legend-color crunch"></span>Crunch Mode
            </span>
            <span class="legend-item">
                <span class="legend-color ai-powered"></span>AI-Powered
            </span>
        </div>
        
        <div class="main-content">
            <div class="chart-container">
                <canvas id="cycleTimeChart"></canvas>
            </div>
            
            <div class="stats" id="stats"></div>
        </div>
    </div>

    <script>
        // Complete weekly cycle time data
        const weeklyData = [
            { week: "2024-01-08", avgCycleHours: 16 },
            { week: "2024-01-15", avgCycleHours: 12.62 },
            { week: "2024-01-22", avgCycleHours: 27.81 },
            { week: "2024-02-05", avgCycleHours: 80.96 },
            { week: "2024-02-12", avgCycleHours: 19.19 },
            { week: "2024-02-19", avgCycleHours: 7.33 },
            { week: "2024-02-26", avgCycleHours: 3.78 },
            { week: "2024-03-04", avgCycleHours: 8.03 },
            { week: "2024-03-10", avgCycleHours: 16 },
            { week: "2024-03-11", avgCycleHours: 91.5 },
            { week: "2024-03-17", avgCycleHours: 16 },
            { week: "2024-03-18", avgCycleHours: 16.05 },
            { week: "2024-03-24", avgCycleHours: 16 },
            { week: "2024-03-25", avgCycleHours: 25.25 },
            { week: "2024-04-01", avgCycleHours: 7.88 },
            { week: "2024-04-07", avgCycleHours: 6.46 },
            { week: "2024-04-08", avgCycleHours: 25.62 },
            { week: "2024-04-15", avgCycleHours: 4.76 },
            { week: "2024-04-21", avgCycleHours: 2.73 },
            { week: "2024-04-22", avgCycleHours: 7.54 },
            { week: "2024-04-29", avgCycleHours: 3.5 },
            { week: "2024-05-05", avgCycleHours: 4.08 },
            { week: "2024-05-06", avgCycleHours: 3.19 },
            { week: "2024-05-12", avgCycleHours: 10.7 },
            { week: "2024-05-13", avgCycleHours: 2.57 },
            { week: "2024-05-19", avgCycleHours: 24 },
            { week: "2024-05-20", avgCycleHours: 10.66 },
            { week: "2024-05-26", avgCycleHours: 5.4 },
            { week: "2024-05-27", avgCycleHours: 12.43 },
            { week: "2024-06-03", avgCycleHours: 12 },
            { week: "2024-06-09", avgCycleHours: 0.1 },
            { week: "2024-06-10", avgCycleHours: 8.2 },
            { week: "2024-06-17", avgCycleHours: 18.67 },
            { week: "2024-06-24", avgCycleHours: 5.85 },
            { week: "2024-07-01", avgCycleHours: 0.1 },
            { week: "2024-07-07", avgCycleHours: 8.05 },
            { week: "2024-07-08", avgCycleHours: 104.03 },
            { week: "2024-07-14", avgCycleHours: 24 },
            { week: "2024-07-15", avgCycleHours: 10.19 },
            { week: "2024-07-22", avgCycleHours: 0.1 },
            { week: "2024-08-05", avgCycleHours: 12.92 },
            { week: "2024-08-12", avgCycleHours: 41.91 },
            { week: "2024-08-19", avgCycleHours: 7.01 },
            { week: "2024-08-25", avgCycleHours: 13.33 },
            { week: "2024-08-26", avgCycleHours: 6.43 },
            { week: "2024-09-01", avgCycleHours: 0.1 },
            { week: "2024-09-02", avgCycleHours: 4.61 },
            { week: "2024-09-09", avgCycleHours: 4.2 },
            { week: "2024-09-15", avgCycleHours: 8.05 },
            { week: "2024-09-16", avgCycleHours: 13.19 },
            { week: "2024-09-22", avgCycleHours: 12.59 },
            { week: "2024-09-23", avgCycleHours: 11.27 },
            { week: "2024-09-29", avgCycleHours: 12.82 },
            { week: "2024-09-30", avgCycleHours: 8 },
            { week: "2024-10-07", avgCycleHours: 40 },
            { week: "2024-10-14", avgCycleHours: 16.02 },
            { week: "2024-10-21", avgCycleHours: 18.03 },
            { week: "2024-10-28", avgCycleHours: 37.82 },
            { week: "2024-11-04", avgCycleHours: 29.2 },
            { week: "2024-11-11", avgCycleHours: 8.79 },
            { week: "2024-11-18", avgCycleHours: 6.5 },
            { week: "2024-11-24", avgCycleHours: 32 },
            { week: "2024-11-25", avgCycleHours: 18.93 },
            { week: "2024-12-01", avgCycleHours: 24 },
            { week: "2024-12-02", avgCycleHours: 33.52 },
            { week: "2024-12-09", avgCycleHours: 24.05 },
            { week: "2024-12-16", avgCycleHours: 9.62 },
            { week: "2024-12-23", avgCycleHours: 3.12 },
            { week: "2025-01-06", avgCycleHours: 21 },
            { week: "2025-01-12", avgCycleHours: 16 },
            { week: "2025-01-13", avgCycleHours: 29.71 },
            { week: "2025-01-19", avgCycleHours: 16.03 },
            { week: "2025-01-20", avgCycleHours: 3.32 },
            { week: "2025-01-26", avgCycleHours: 12 },
            { week: "2025-01-27", avgCycleHours: 16.07 },
            { week: "2025-02-03", avgCycleHours: 6.44 },
            { week: "2025-02-10", avgCycleHours: 13.15 },
            { week: "2025-02-17", avgCycleHours: 10.15 },
            { week: "2025-02-23", avgCycleHours: 18.14 },
            { week: "2025-02-24", avgCycleHours: 9.32 },
            { week: "2025-03-02", avgCycleHours: 16 },
            { week: "2025-03-03", avgCycleHours: 4.79 },
            { week: "2025-03-10", avgCycleHours: 7.31 },
            { week: "2025-03-16", avgCycleHours: 8 },
            { week: "2025-03-17", avgCycleHours: 11.95 },
            { week: "2025-03-24", avgCycleHours: 21.51 },
            { week: "2025-03-31", avgCycleHours: 11.25 },
            { week: "2025-04-07", avgCycleHours: 17.99 },
            { week: "2025-04-14", avgCycleHours: 18.86 },
            { week: "2025-04-21", avgCycleHours: 15.05 },
            { week: "2025-04-27", avgCycleHours: 28.1 },
            { week: "2025-04-28", avgCycleHours: 15.66 },
            { week: "2025-05-04", avgCycleHours: 13.33 },
            { week: "2025-05-05", avgCycleHours: 4.07 },
            { week: "2025-05-12", avgCycleHours: 10.96 },
            { week: "2025-05-18", avgCycleHours: 17.62 },
            { week: "2025-05-19", avgCycleHours: 69.17 },
            { week: "2025-05-26", avgCycleHours: 10.42 },
            { week: "2025-06-01", avgCycleHours: 9.64 },
            { week: "2025-06-02", avgCycleHours: 3.3 },
            { week: "2025-06-08", avgCycleHours: 16.02 },
            { week: "2025-06-09", avgCycleHours: 10.33 },
            { week: "2025-06-15", avgCycleHours: 4.05 },
            { week: "2025-06-16", avgCycleHours: 4.76 },
            { week: "2025-06-22", avgCycleHours: 407.32 },
            { week: "2025-06-23", avgCycleHours: 14.09 },
            { week: "2025-06-29", avgCycleHours: 16 },
            { week: "2025-06-30", avgCycleHours: 15.34 },
            { week: "2025-07-07", avgCycleHours: 104 },
            { week: "2025-07-21", avgCycleHours: 11.88 },
            { week: "2025-07-28", avgCycleHours: 8.36 },
            { week: "2025-08-04", avgCycleHours: 13.2 },
            { week: "2025-08-10", avgCycleHours: 16 },
            { week: "2025-08-11", avgCycleHours: 9.73 },
            { week: "2025-08-18", avgCycleHours: 10.34 }
        ];

        // Remove outliers for better visualization (keep values under 100 hours)
        const filteredData = weeklyData.map(item => ({
            ...item,
            avgCycleHours: item.avgCycleHours > 100 ? 100 : item.avgCycleHours
        }));

        // Aggregate by month
        const monthlyAggregation = {};
        
        filteredData.forEach(item => {
            const date = new Date(item.week);
            const monthKey = date.getFullYear() + '-' + String(date.getMonth() + 1).padStart(2, '0');
            
            if (!monthlyAggregation[monthKey]) {
                monthlyAggregation[monthKey] = {
                    values: [],
                    sum: 0,
                    count: 0
                };
            }
            
            monthlyAggregation[monthKey].values.push(item.avgCycleHours);
            monthlyAggregation[monthKey].sum += item.avgCycleHours;
            monthlyAggregation[monthKey].count += 1;
        });

        // Create monthly data array
        const monthlyData = Object.keys(monthlyAggregation).sort().map(month => ({
            month: month,
            avgCycleTime: monthlyAggregation[month].sum / monthlyAggregation[month].count,
            weekCount: monthlyAggregation[month].count
        }));

        // Calculate June 2025 split (AI introduced June 20)
        // Get June weeks for calculation
        const juneWeeks = filteredData.filter(item => item.week.startsWith('2025-06'));
        
        // Pre-AI weeks (before June 20): 6/1, 6/2, 6/8, 6/9, 6/15, 6/16 (first 4 days)
        const preAIWeeks = juneWeeks.filter(item => {
            const weekDate = new Date(item.week);
            return weekDate < new Date('2025-06-20');
        });
        
        // Post-AI weeks (after June 20): 6/16 (last day), 6/22, 6/23, 6/29, 6/30
        const postAIWeeks = juneWeeks.filter(item => {
            const weekDate = new Date(item.week);
            return weekDate >= new Date('2025-06-22');
        });

        // Calculate averages
        const junePreAI = preAIWeeks.reduce((sum, item) => sum + item.avgCycleHours, 0) / preAIWeeks.length;
        const junePostAI = postAIWeeks.reduce((sum, item) => sum + item.avgCycleHours, 0) / postAIWeeks.length;

        // Important dates
        const crunchStart = new Date('2024-04-08');
        const crunchEnd = new Date('2024-05-19');
        const aiIntroDate = new Date('2025-06-20');

        // Create labels - only show every 3rd month
        const labels = monthlyData.map((item, index) => {
            const [year, month] = item.month.split('-');
            const date = new Date(year, parseInt(month) - 1);
            // Show label for January, April, July, October
            if (parseInt(month) % 3 === 1) {
                return date.toLocaleDateString('en-US', { month: 'short', year: '2-digit' });
            }
            return ''; // Empty label for other months
        });

        // Determine colors
        const colors = monthlyData.map(item => {
            const [year, month] = item.month.split('-');
            const monthDate = new Date(year, parseInt(month) - 1, 15);
            
            if (monthDate >= aiIntroDate) {
                return '#27ae60'; // Green for AI-powered
            } else if (item.month === '2024-04' || item.month === '2024-05' || item.month === '2025-01') {
                return '#e74c3c'; // Red for crunch periods
            } else {
                return '#95a5a6'; // Gray for pre-AI
            }
        });

        // Calculate statistics
        const preAIData = monthlyData.filter(item => {
            const [year, month] = item.month.split('-');
            const monthDate = new Date(year, parseInt(month) - 1, 15);
            return monthDate < aiIntroDate && !['2024-04', '2024-05', '2025-01'].includes(item.month);
        });
        
        const postAIData = monthlyData.filter(item => {
            return ['2025-07', '2025-08'].includes(item.month);
        });
        
        // Add June portions to calculations
        const avgPreAI = (preAIData.reduce((sum, item) => sum + item.avgCycleTime, 0) + junePreAI) / (preAIData.length + 1);
        const avgPostAI = (postAIData.reduce((sum, item) => sum + item.avgCycleTime, 0) + junePostAI) / (postAIData.length + 1);
        
        // Custom plugin for June split - only draws the green bar on top
        const customPlugin = {
            id: 'customBars',
            afterDatasetsDraw: function(chart) {
                const ctx = chart.ctx;
                const meta = chart.getDatasetMeta(0);
                const juneIndex = monthlyData.findIndex(item => item.month === '2025-06');
                
                if (juneIndex !== -1) {
                    const bar = meta.data[juneIndex];
                    const barWidth = bar.width;
                    const barX = bar.x - barWidth / 2;
                    const barBottom = bar.base;
                    const borderRadius = 4;
                    
                    // Get animation progress from the June bar itself
                    let animationProgress = 1;
                    if (chart.animating) {
                        // The bar's current height vs its final height gives us the progress
                        const currentHeight = bar.height || 0;
                        const finalHeight = barBottom - chart.scales.y.getPixelForValue(junePreAI);
                        animationProgress = finalHeight > 0 ? currentHeight / finalHeight : 0;
                    }
                    
                    // Calculate position for post-AI green bar
                    const postAIY = chart.scales.y.getPixelForValue(junePostAI);
                    const postAIFullHeight = barBottom - postAIY;
                    const postAIHeight = postAIFullHeight * animationProgress;
                    const animatedPostAIY = barBottom - postAIHeight;
                    
                    if (postAIHeight > 0) {
                        ctx.save();
                        
                        // Draw post-AI portion (right 1/3) on top of the gray bar
                        ctx.fillStyle = '#27ae60';
                        ctx.fillRect(barX + barWidth * 2/3, animatedPostAIY, barWidth / 3, postAIHeight);
                        
                        // Post-AI rounded top (only if tall enough)
                        if (postAIHeight > borderRadius) {
                            ctx.beginPath();
                            ctx.moveTo(barX + barWidth * 2/3, animatedPostAIY + borderRadius);
                            ctx.quadraticCurveTo(barX + barWidth * 2/3, animatedPostAIY, barX + barWidth * 2/3 + borderRadius, animatedPostAIY);
                            ctx.lineTo(barX + barWidth - borderRadius, animatedPostAIY);
                            ctx.quadraticCurveTo(barX + barWidth, animatedPostAIY, barX + barWidth, animatedPostAIY + borderRadius);
                            ctx.closePath();
                            ctx.fill();
                        }
                        
                        // Post-AI border
                        ctx.strokeStyle = '#229954';
                        ctx.lineWidth = 1;
                        ctx.strokeRect(barX + barWidth * 2/3, animatedPostAIY, barWidth / 3, postAIHeight);
                        
                        ctx.restore();
                    }
                }
            }
        };

        // Create chart
        const ctx = document.getElementById('cycleTimeChart').getContext('2d');
        const chart = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: labels,
                datasets: [{
                    label: 'Average Cycle Time (Hours)',
                    data: monthlyData.map(item => {
                        // For June, return the pre-AI value so the gray bar animates correctly
                        if (item.month === '2025-06') {
                            return junePreAI;
                        }
                        return item.avgCycleTime;
                    }),
                    backgroundColor: colors,
                    borderColor: colors.map(color => {
                        if (color === '#e74c3c') return '#c0392b';
                        if (color === '#27ae60') return '#229954';
                        return '#7f8c8d';
                    }),
                    borderWidth: 1,
                    borderRadius: {
                        topLeft: 4,
                        topRight: 4,
                        bottomLeft: 0,
                        bottomRight: 0
                    }
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    title: {
                        display: false
                    },
                    legend: {
                        display: false
                    },
                    tooltip: {
                        callbacks: {
                            title: function(context) {
                                const monthData = monthlyData[context[0].dataIndex];
                                const [year, month] = monthData.month.split('-');
                                const date = new Date(year, parseInt(month) - 1);
                                return date.toLocaleDateString('en-US', { month: 'short', year: 'numeric' });
                            },
                            label: function(context) {
                                const monthData = monthlyData[context.dataIndex];
                                if (monthData.month === '2025-06') {
                                    return [
                                        `Pre-AI (2/3): ${junePreAI.toFixed(1)} hours`,
                                        `Post-AI (1/3): ${junePostAI.toFixed(1)} hours`,
                                        `Overall: ${monthData.avgCycleTime.toFixed(1)} hours`
                                    ];
                                }
                                const value = monthData.avgCycleTime.toFixed(1);
                                const weeks = monthData.weekCount;
                                return `Avg: ${value} hours (${weeks} weeks)`;
                            },
                            afterLabel: function(context) {
                                const month = monthlyData[context.dataIndex].month;
                                if (month === '2025-06') {
                                    return 'AI introduced June 20';
                                } else if (['2024-04', '2024-05', '2025-01'].includes(month)) {
                                    return 'Crunch Period';
                                } else if (['2025-07', '2025-08'].includes(month)) {
                                    return 'AI-Powered';
                                }
                                return 'Pre-AI';
                            }
                        }
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        title: {
                            display: true,
                            text: 'Average Cycle Time (Hours)'
                        },
                        ticks: {
                            callback: function(value) {
                                return value + 'h';
                            }
                        }
                    },
                    x: {
                        title: {
                            display: false
                        }
                    }
                }
            },
            plugins: [customPlugin]
        });

        // Populate statistics
        const percentIncrease = ((avgPostAI / avgPreAI - 1) * 100).toFixed(0);
        
        document.getElementById('stats').innerHTML = `
            <div class="stat-box">
                <div class="stat-value">${avgPreAI.toFixed(1)}h</div>
                <div class="stat-label">Avg Cycle Time<br>(Pre-AI)</div>
            </div>
            <div class="stat-box">
                <div class="stat-value">${avgPostAI.toFixed(1)}h</div>
                <div class="stat-label">Avg Cycle Time<br>(AI-Powered)</div>
            </div>
            <div class="stat-box">
                <div class="stat-value improvement-positive">+${percentIncrease}%</div>
                <div class="stat-label">Cycle Time<br>Evolution</div>
            </div>
        `;
    </script>
</body>
</html>